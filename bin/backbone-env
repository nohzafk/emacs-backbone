#!/usr/bin/env bash
# backbone-env - Generate environment variable file for Emacs Backbone
# Usage: backbone-env -o OUTPUT_FILE

set -euo pipefail

# Parse arguments
output_file=""
while [[ $# -gt 0 ]]; do
  case $1 in
    -o)
      output_file="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1" >&2
      echo "Usage: backbone-env -o OUTPUT_FILE" >&2
      exit 1
      ;;
  esac
done

if [[ -z "$output_file" ]]; then
  echo "Error: Output file not specified. Use -o OUTPUT_FILE" >&2
  exit 1
fi

# Ensure output directory exists
mkdir -p "$(dirname "$output_file")"

# Generate environment variables file
# Capture environment from current process (caller should source configs if needed)
env | {
  # Read all environment variables
  env_vars=()
  while IFS= read -r line; do
    # Only include lines that look like KEY=VALUE
    if [[ "$line" =~ ^[A-Za-z_][A-Za-z0-9_]*= ]]; then
      env_vars+=("$line")
    fi
  done

  # Write to file in Lisp format
  cat > "$output_file" <<'EOF'
;; -*- mode: lisp-interaction; coding: utf-8-unix; -*-
;; ---------------------------------------------------------------------------
;; This file was auto-generated by `backbone-env'. It contains a list of
;; environment variables scraped from your shell environment.
;;
;; Load it with (backbone-load-envvars-file "~/.config/backbone/env").

EOF

  # Write the Lisp list of env vars
  echo "(" >> "$output_file"
  for var in "${env_vars[@]}"; do
    # Escape the value properly for Lisp (backslashes first, then quotes)
    escaped="${var//\\/\\\\}"
    escaped="${escaped//\"/\\\"}"
    printf ' "%s"\n' "$escaped" >> "$output_file"
  done
  echo ")" >> "$output_file"

  echo "Generated environment file: $output_file"
}
